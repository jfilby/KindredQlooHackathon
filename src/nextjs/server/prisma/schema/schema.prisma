// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "core"]
}

// Kindred: Batch

model BatchJob {
  id                           String           @id @default(cuid())
  instanceId                   String?          @map("instance_id")
  instance                     Instance?        @relation(fields: [instanceId], references: [id])
  userProfileId                String?          @map("user_profile_id")
  userProfile                  UserProfile?     @relation(fields: [userProfileId], references: [id])
  runInATransaction            Boolean          @map("run_in_a_transaction")
  status                       String           @db.Char(1)
  progressPct                  Int?             @map("progress_pct")
  message                      String?
  jobType                      String           @map("job_type")
  refModel                     String?          @map("ref_model")
  refId                        String?          @map("ref_id")
  parameters                   String?          // Stringified JSON
  created                      DateTime         @default(now())
  updated                      DateTime         @updatedAt

  ofUserInterestTexts          UserInterestText[]

  @@index([refId])
  @@map("batch_job")
  @@schema("public")
}

// Kindred: Qloo

model QlooAudience {
  id                           String               @id @default(cuid())
  name                         String               @unique
  platforms                    String[]
  keywords                     String[]

  ofQlooAudiencePersonas       QlooAudiencePersona[]

  @@map("qloo_audience")
  @@schema("public")
}

model QlooAudiencePersona {
  id                           String               @id @default(cuid())
  qlooAudienceId               String               @map("qloo_audience_id")
  qlooAudience                 QlooAudience         @relation(fields: [qlooAudienceId], references: [id])
  name                         String
  description                  String

  @@unique([qlooAudienceId, name])
  @@map("qloo_audience_persona")
  @@schema("public")
}

model QlooEntity {
  id                           String               @id @default(cuid())
  qlooEntityId                 String               @map("qloo_entity_id") @unique
  isTrending                   Boolean              @map("is_trending")
  name                         String
  disambiguation               String
  types                        String[]
  popularity                   Float
  json                         Json                 @db.JsonB
  created                      DateTime             @default(now())
  updated                      DateTime             @updatedAt

  ofEntityInterests            EntityInterest[]

  @@map("qloo_entity")
  @@schema("public")
}

model QlooTagType {
  id                           String               @id @default(cuid())
  urn                          String               @unique
  entityTypes                  String[]             @map("entity_types")

  @@map("qloo_tag_type")
  @@schema("public")
}

// Kindred: AI Personas

model AiPersona {
  // The userProfileId is the user that the AI persona is created for
  id                           String               @id @default(cuid())
  userProfileId                String               @map("user_profile_id")
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  status                       String               @db.Char(1)  // A (active), P (delete pending)
  name                         String
  gender                       String
  dateOfBirth                  DateTime             @map("date_of_birth")
  description                  String
  prompt                       String?
  created                      DateTime             @default(now())
  updated                      DateTime             @updatedAt

  // ofAiPersonaDomainInterests   AiPersonaDomainInterest[]
  // ofAiPersonaEntityInterests   AiPersonaEntityInterest[]

  @@unique([userProfileId, name])
  @@map("ai_persona")
  @@schema("public")
}

// Kindred: Interests

/* model AiPersonaDomainInterest {
  id                           String               @id @default(cuid())
  aiPersonaId                  String               @map("ai_persona_id")
  aiPersona                    AiPersona            @relation(fields: [aiPersonaId], references: [id])
  domainInterestId             String               @map("domain_interest_id")
  domainInterest               DomainInterest       @relation(fields: [domainInterestId], references: [id])

  @@unique([aiPersonaId, domainInterestId])
  @@map("ai_persona_domain_interest")
  @@schema("public")
}

model AiPersonaEntityInterest {
  id                           String               @id @default(cuid())
  aiPersonaId                  String               @map("ai_persona_id")
  aiPersona                    AiPersona            @relation(fields: [aiPersonaId], references: [id])
  entityInterestId             String               @map("entity_interest_id")
  entityInterest               EntityInterest       @relation(fields: [entityInterestId], references: [id])

  @@unique([aiPersonaId, entityInterestId])
  @@map("ai_persona_entity_interest")
  @@schema("public")
}

model UserDomainInterest {
  id                           String               @id @default(cuid())
  userProfileId                String               @map("user_profile_id")
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  domainInterestId             String               @map("domain_interest_id")
  domainInterest               DomainInterest       @relation(fields: [domainInterestId], references: [id])

  @@unique([userProfileId, domainInterestId])
  @@map("user_domain_interest")
  @@schema("public")
} */

model EntityInterest {
  id                           String               @id @default(cuid())
  interestTypeId               String               @map("interest_type_id")
  interestType                 InterestType         @relation(fields: [interestTypeId], references: [id])
  qlooEntityId                 String?              @map("qloo_entity_id")
  qlooEntity                   QlooEntity?          @relation(fields: [qlooEntityId], references: [id])
  name                         String               @unique

  // ofAiPersonaEntityInterest    AiPersonaEntityInterest[]
  ofUserInterests              UserInterest[]

  @@unique([interestTypeId, name])
  @@map("entity_interest")
  @@schema("public")
}

model InterestType {
  id                           String               @id @default(cuid())
  qlooEntityType               String?              @map("qloo_entity_type")
  name                         String               @unique

  ofEntityInterests            EntityInterest[]
  // ofAiPersonaDomainInterests   AiPersonaDomainInterest[]
  // ofUserDomainInterests        UserDomainInterest[]

  @@map("interest_type")
  @@schema("public")
}

model UserInterest {
  id                           String               @id @default(cuid())
  userProfileId                String               @map("user_profile_id")
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  entityInterestId             String               @map("entity_interest_id")
  entityInterest               EntityInterest       @relation(fields: [entityInterestId], references: [id])

  @@unique([userProfileId, entityInterestId])
  @@map("user_interest")
  @@schema("public")
}

model UserInterestText {
  // Used to save interest text before its resolved to UserInterests.
  id                           String               @id @default(cuid())
  userProfileId                String               @map("user_profile_id") @unique
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  batchJobId                   String               @map("batch_job_id")
  batchJob                     BatchJob             @relation(fields: [batchJobId], references: [id])
  text                         String

  @@map("user_interest_text")
  @@schema("public")
}

// Kindred: social media

model Comment {
  id                           String               @id @default(cuid())
  parentId                     String?              @map("parent_id")
  parent                       Comment?             @relation("parent", fields: [parentId], references: [id])
  postId                       String               @map("post_id")
  post                         Post                 @relation(fields: [postId], references: [id])
  text                         String
  externalId                   String?
  posted                       DateTime

  ofComments                   Comment[]            @relation("parent")

  @@unique([postId, externalId])
  @@map("comment")
  @@schema("public")
}

model Post {
  id                           String               @id @default(cuid())
  siteId                       String               @map("site_id")
  site                         Site                 @relation(fields: [siteId], references: [id])
  postUrlId                    String?              @map("post_url_id")
  postUrl                      PostUrl?             @relation(fields: [postUrlId], references: [id])
  externalId                   String?
  title                        String
  posted                       DateTime
  checkedComments              DateTime?            @map("checked_comments")

  ofComments                   Comment[]
  ofPostSummaries              PostSummary[]
  ofPostTopics                 PostTopic[]
  ofSiteTopicListPosts         SiteTopicListPost[]

  @@unique([siteId, externalId])
  @@map("post")
  @@schema("public")
}

model PostTopic {
  id                           String               @id @default(cuid())
  postId                       String               @map("post_id")
  post                         Post                 @relation(fields: [postId], references: [id])
  siteTopicId                  String               @map("site_topic_id")
  siteTopic                    SiteTopic            @relation(fields: [siteTopicId], references: [id])

  @@unique([postId, siteTopicId])
  @@map("post_topic")
  @@schema("public")
}

model PostUrl {
  id                           String               @id @default(cuid())
  url                          String               @unique
  verified                     Boolean
  title                        String?
  text                         String?
  created                      DateTime         @default(now())
  updated                      DateTime         @updatedAt

  ofPosts                      Post[]
  ofPostUrlSummaries           PostUrlSummary[]

  @@map("post_url")
  @@schema("public")
}

model Site {
  id                           String               @id @default(cuid())
  name                         String               @unique

  ofPosts                      Post[]
  ofSiteTopics                 SiteTopic[]

  @@map("site")
  @@schema("public")
}

model SiteTopic {
  id                           String               @id @default(cuid())
  siteId                       String               @map("site_id")
  site                         Site                 @relation(fields: [siteId], references: [id])
  name                         String

  ofPostTopics                 PostTopic[]
  ofSiteTopicLists             SiteTopicList[]

  @@unique([siteId, name])
  @@map("site_topic")
  @@schema("public")
}

model SiteTopicList {
  id                           String               @id @default(cuid())
  siteTopicId                  String               @map("site_topic_id")
  siteTopic                    SiteTopic            @relation(fields: [siteTopicId], references: [id])
  rankingType                  String               @map("ranking_type")
  listed                       DateTime

  ofSiteTopicListPosts         SiteTopicListPost[]

  @@unique([siteTopicId, rankingType, listed])
  @@map("site_topic_list")
  @@schema("public")
}

model SiteTopicListPost {
  id                           String               @id @default(cuid())
  siteTopicListId              String               @map("site_topic_list_id")
  siteTopicList                SiteTopicList        @relation(fields: [siteTopicListId], references: [id])
  postId                       String               @map("post_id")
  post                         Post                 @relation(fields: [postId], references: [id])
  index                        Int

  @@unique([siteTopicListId, postId])
  @@unique([siteTopicListId, index])
  @@map("site_topic_list_post")
  @@schema("public")
}

// Kindred: LLM-generated summaries

model PostSummary {
  id                           String               @id @default(cuid())
  postId                       String               @map("post_id")
  post                         Post                 @relation(fields: [postId], references: [id])
  userProfileId                String               @map("user_profile_id")
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  status                       String               @db.Char(1)
  text                         String
  created                      DateTime             @default(now())
  updated                      DateTime             @updatedAt

  @@unique([postId, userProfileId])
  @@map("post_summary")
  @@schema("public")
}

model PostUrlSummary {
  id                           String               @id @default(cuid())
  postUrlId                    String               @map("post_url_id")
  postUrl                      PostUrl              @relation(fields: [postUrlId], references: [id])
  userProfileId                String               @map("user_profile_id")
  userProfile                  UserProfile          @relation(fields: [userProfileId], references: [id])
  status                       String               @db.Char(1)
  text                         String
  created                      DateTime             @default(now())
  updated                      DateTime             @updatedAt

  @@unique([postUrlId, userProfileId])
  @@map("post_url_summary")
  @@schema("public")
}

// Kindred: Search

model ResultUrl {
  id                           String               @id @default(cuid())
  url                          String               @unique
  title                        String
  verifiedOk                   Boolean              @map("verified_ok")
  lastPinged                   DateTime?            @map("last_pinged")

  ofSearchResultUrls           SearchQueryResultUrl[]

  @@map("result_url")
  @@schema("public")
}

model SearchQuery {
  id                           String               @id @default(cuid())
  userProfileId                String?              @map("user_profile_id")
  userProfile                  UserProfile?         @relation(fields: [userProfileId], references: [id])
  query                        String               @unique

  ofSearchQueryResults         SearchQueryResult[]

  @@map("search_query")
  @@schema("public")
}

model SearchQueryResult {
  id                           String               @id @default(cuid())
  searchQueryId                String               @map("search_query_id")
  searchQuery                  SearchQuery          @relation(fields: [searchQueryId], references: [id])
  index                        Int
  title                        String
  description                  String

  ofSearchQueryResultUrls      SearchQueryResultUrl[]

  @@unique([searchQueryId, title])
  @@map("search_query_result")
  @@schema("public")
}

model SearchQueryResultUrl {
  id                           String               @id @default(cuid())
  searchQueryResultId          String               @map("search_result_id")
  searchQueryResult            SearchQueryResult    @relation(fields: [searchQueryResultId], references: [id])
  resultUrlId                  String               @map("url_id")
  resultUrl                    ResultUrl            @relation(fields: [resultUrlId], references: [id])

  @@unique([searchQueryResultId, resultUrlId])
  @@map("search_query_result_url")
  @@schema("public")
}
